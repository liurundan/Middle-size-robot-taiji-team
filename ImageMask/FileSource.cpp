#include "StdAfx.h"
#include "FileSource.h"
#include <fstream>

using namespace std;

FileSource::FileSource(ImageIO* imageIO, const string& filename)
    : ImageSource(), imageIO(imageIO), pos(0), width(0), height(0)
  {
    ifstream in(filename.c_str());
    if (!in) 
	{
      throw BadHardwareException(__FILE__": Could not open file.");
    }
    string type;
    in >> type;
    if (! (type == "single")) 
	{
      throw BadHardwareException(__FILE__": This type is not supported.");
    }

    string ioType;
    in >> ioType;
    if (! (ioType == imageIO->getTypeId())) 
	{
      throw BadHardwareException(__FILE__": The file type does not match "
				 "the imageIO you have provided");
    }

    int n;
    string imgFile;
    long timestamp;
    Time time;
    while(in) 
	{
      in >> n >> imgFile >> timestamp;
      time.set_msec(timestamp);
      images.push_back(FileInfo(n, imgFile, time));
    }
    in.close();

    if (images.size() == 0) 
	{
      throw BadHardwareException(__FILE__": File does not conatain any images.");
    }

    image  = imageIO->read(0, images[0].filename);  
    width  = image->getWidth();
    height = image->getHeight();
  }

  FileSource::~FileSource()
  {
    if (imageIO) 
	{
      delete imageIO;
    }
    delete image;
  }

  ImageBuffer FileSource::getImage() throw (HardwareException)
  {
    image				= getNextImage(image);
    ImageBuffer buffer	= image->getImageBuffer();
    return buffer;
  }

  Image* FileSource::getNextImage(Image* image)
  {
    if( pos < images.size() - 2 )
	  pos = (pos+1) % images.size();
	else
	  pos = 0;
    image = imageIO->read(image, images[pos].filename);
    image->setTimestamp(images[pos].timestamp);
    return image;
  }

  Image* FileSource::getPrevImage(Image* image)
  {
    pos = (pos-1+images.size()) % images.size();
    image = imageIO->read(image, images[pos].filename);
    image->setTimestamp(images[pos].timestamp);
    return image;
  }

  string FileSource::getFilename() const
  {
    return images[pos].filename;
  }

  Time FileSource::getTimestamp() const
  {
    return images[pos].timestamp;
  }

 
  Image* FileSource::getImageNumber(int n, Image* image)
  {
     while (pos < (int)images.size()-1 && n > images[pos].n)
	 {
      pos++;
	 } 
    
     while (pos > 0 && n < images[pos].n) 
	 {
      pos--;
	 } 
     image = imageIO->read(image, images[pos].filename);
     image->setTimestamp(images[pos].timestamp);
     return image;
  }
